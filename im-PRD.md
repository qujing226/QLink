DID‑QLink 通讯子系统 PRD（1 对 1 模式）
1. 背景与目标
- 背景：区块链部分已实现 DID 注册、解析与哈希校验，保证身份与公钥的可信性。
- 目标：设计一个支持 1 对 1 安全通信的子系统，用户通过 DID/VC 建立连接，完成质询认证与 KEM 密钥协商，随后进行加密通信。
- 范围：仅支持点对点通信，不涉及群聊、转发、广播。

2. 用户故事
- 注册与登录
- 用户通过 DID 或 VC 登录通讯系统。
- 系统从区块链解析 DID Document，确认身份。
- 添加好友
- 用户 A 输入用户 B 的 DID。
- 系统解析 B 的 DID Document，获取其公钥（P‑256 + Kyber768）。
- 系统发起好友请求，等待 B 确认。
- 认证与密钥协商
- 双方通过质询‑应答完成身份认证。
- 使用 Kyber768 KEM 协商会话密钥。
- 会话密钥用于 AES‑GCM 加密通信。
- 安全通信
- 双方建立加密通道，消息端到端加密。
- 会话密钥定期轮换，支持断线重连。

3. 功能需求
   3.1 登录与身份管理
- 支持用户输入 DID 或 VC 登录。
- 系统调用区块链解析 DID Document，校验哈希一致性。
- 登录后生成本地会话 token，绑定 DID。
  3.2 好友管理
- 添加好友：输入对方 DID → 解析 Document → 发起请求。
- 好友确认：对方同意后，双方进入可通信状态。
- 好友列表：本地存储 DID 与状态。
  3.3 认证与质询
- 认证流程：
- A 请求与 B 建立会话。
- B 生成随机 nonce，发送给 A。
- A 使用 DID Document 中的签名密钥签名 nonce，返回给 B。
- B 验签成功 → 身份确认。
- 双方互换角色，完成双向认证。
  3.4 密钥协商
- 使用 Kyber768 KEM：
- A 获取 B 的 Kyber 公钥，Encapsulate → (ct, ssA)。
- A 发送 ct 给 B。
- B Decapsulate(ct) → ssB。
- 验证 ssA == ssB，得到共享会话密钥。
- 会话密钥输入 KDF → 生成 AES‑GCM 密钥。
  3.5 加密通信
- 消息格式：
```Json
{
  "from": DID,
  "to": DID,
  "timestamp": ...,
  "ciphertext": ...,
  "nonce": ...
}
```

- 加密算法：AES‑256‑GCM
- 支持消息完整性校验（tag）。
- 支持断线重连时重新协商会话密钥。
  3.6 会话管理
- 会话密钥有效期：默认 30 分钟或 1000 条消息。
- 支持自动轮换：到期后重新执行 KEM 协商。
- 会话结束：双方销毁密钥，清理缓存。

4. 非功能需求
- 性能：单次握手延迟 < 200ms（本地链环境）。
- 安全性：重放攻击拦截率 100%，篡改检测率 100%。
- 可用性：断线重连成功率 ≥ 99%。

5. 系统架构（通讯部分）
```text

[用户A客户端] ←→ [通讯服务] ←→ [用户B客户端]
       |                          |
       |—— DID/VC 登录 ————→      |
       |                          |
       |—— 添加好友(DID) ———→      |
       |                          |
       |—— 质询认证 ———————→      |
       |                          |
       |—— Kyber768 KEM ———→      |
       |                          |
       |—— AES-GCM 加密通信 ——→    |
```

6. 接口设计（示例）
- 登录
```Json
- POST /login
{ "did": "did:QLink:chain123:abc123", "vc": "..." }
```
- 添加好友
```Json
- POST /friend/add
{ "targetDid": "did:QLink:chain123:def456" }
```
- 发起认证
```Json
- POST /auth/challenge
{ "targetDid": "..." }
```
- 发送消息
```Json
- POST /message/send
{ "to": "...", "ciphertext": "...", "nonce": "..." }
```
7. 安全设计
- 防重放：nonce + 时间戳校验。
- 防篡改：链上哈希校验 DID Document。
- 密钥轮换：定期重新协商。
- 错误处理：统一错误码，不泄露内部细节。
