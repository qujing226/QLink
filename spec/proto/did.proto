syntax = "proto3";

package didproto;

import "buf/validate/validate.proto";

option go_package = "./didproto";

/* =========================================================================
 * Top Level Envelope (TCP Frame Body)
 * ========================================================================= */

// Packet represents the unmarshaled body of a Length-Prefixed TCP frame.
message Packet {
  // Common header for routing, tracing, and context binding.
  Header header = 1 [(buf.validate.field).required = true]; 

  // Mutually exclusive payload types.
  oneof payload {
    option (buf.validate.oneof).required = true;

    KEMInit kem_init = 10;                // Step 1: Handshake Initiation
    KEMConfirm kem_confirm = 11;          // Step 2: Handshake Confirmation
    SecureMessage secure_message = 12;    // Step 3: Encrypted Communication
    
    DIDDocumentRequest did_request = 13;  // Infrastructure: Query DID
    DIDDocumentResponse did_response = 14;// Infrastructure: Return DID
    
    Status status = 15;                   // Generic status/error response
  }
}

/* =========================================================================
 * Common Structures
 * ========================================================================= */

message Header {
  string request_id = 1 [(buf.validate.field).string.uuid = true];                     // UUID for request tracing
  string from_did   = 2 [(buf.validate.field).string.pattern = "^did:[a-z0-9]+:.*$"];  // Sender DID
  string to_did     = 3 [(buf.validate.field).string.pattern = "^did:[a-z0-9]+:.*$"];  // Receiver DID (for Relay routing)
  int64  timestamp  = 4 [(buf.validate.field).int64.gt = 0];                           // Unix timestamp (ms) for replay protection
}

// Unified status response for all request types.
message Status {
  string reply_to_id = 1 [(buf.validate.field).string.uuid = true]; // ID of the request being responded to

  enum Code {
    SUCCESS                   = 0;
    ERROR_GENERIC             = 1;
    ERROR_VERIFICATION_FAILED = 2; // Signature or hash check failed
    ERROR_DID_NOT_FOUND       = 3; // DID resolution failed
    ERROR_DECRYPTION_FAILED   = 4; // Kyber or AES decryption failed
  }
  Code   code    = 2; // Result code
  string message = 3; // Detailed error message (empty if SUCCESS)
}

// SessionState defines the formal lifecycle of a QLink session.
enum SessionState {
  STATE_IDLE         = 0; // Initial state
  STATE_RESOLVING    = 1; // Blocking on chain resolution (Slow Path)
  STATE_SPECULATIVE  = 2; // Optimistic execution based on cache (Fast Path)
  STATE_VERIFIED     = 3; // Cryptographically verified against on-chain trust anchor
  STATE_COMPROMISED  = 4; // Security violation detected (Rollback triggered)
}

/* =========================================================================
 * Handshake Payloads (Kyber768)
 * ========================================================================= */

message KEMInit {
  bytes ct        = 1 [(buf.validate.field).bytes.len = 1088]; // Kyber768 encapsulated key (fixed 1088 bytes)
  bytes nonce     = 2 [(buf.validate.field).bytes.len = 32];   // Random nonce (32 bytes) for key derivation
  bytes signature = 3 [(buf.validate.field).required = true];  // Sign(Header || ct || nonce) by Initiator
}

message KEMConfirm {
  bytes nonce_hash = 1 [(buf.validate.field).bytes.len = 32];   // SHA-256 hash of the received nonce
  bytes signature  = 2 [(buf.validate.field).required = true];  // Sign(Header || nonce_hash) by Responder
}

/* =========================================================================
 * Communication Payload (AES-256-GCM)
 * ========================================================================= */

message SecureMessage {
  uint64 sequence_number = 1;                                      // Strictly increasing seq num to prevent reordering
  bytes  ciphertext      = 2 [(buf.validate.field).required = true]; // AES-GCM encrypted payload
  bytes  nonce           = 3 [(buf.validate.field).bytes.len = 12];  // AES-GCM nonce (standard 12 bytes)
  bytes  tag             = 4 [(buf.validate.field).bytes.len = 16];  // AES-GCM auth tag (standard 16 bytes)
}

/* =========================================================================
 * Infrastructure Payloads
 * ========================================================================= */

message DIDDocumentRequest {
  string target_did = 1 [(buf.validate.field).string.pattern = "^did:[a-z0-9]+:.*$"]; // DID to lookup
}

message DIDDocumentResponse {
  oneof result {
    option (buf.validate.oneof).required = true;
    
    bytes  document = 1; // Serialized DID Document (JSON-LD)
    string error    = 2; // Error message if lookup failed
  }
}